name: Release tagged build

on:
  push:
    tags: [ '*' ]

permissions:
  contents: write

jobs:
  # GTNH 工作流负责构建和 GitHub Release
  build:
    uses: GTNewHorizons/GTNH-Actions-Workflows/.github/workflows/release-tags.yml@master

  # 发布到 Maven Central（需要 Java 21 运行 Gradle）
  publish-maven-central:
    needs: build
    if: vars.MAVEN_PUBLISHING_URL != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download jars from GitHub Release
        run: |
          mkdir -p build/libs
          gh release download "${{ github.ref_name }}" -p "*.jar" -D build/libs
          ls -la build/libs/
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Sign and publish to Maven Central
        run: |
          chmod +x ./gradlew
          ./gradlew publish -x test -x jar -x shadowJar \
            -PmavenPublishUrl="${{ vars.MAVEN_PUBLISHING_URL }}" \
            -PMAVEN_USER="${{ secrets.MAVEN_USER }}" \
            -PMAVEN_PASSWORD="${{ secrets.MAVEN_PASSWORD }}"
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
